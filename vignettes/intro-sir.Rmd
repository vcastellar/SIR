---
title: "Introduction to SIR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to SIR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 4
)
```

The **SIR** package provides tools to simulate and analyze deterministic
compartmental epidemic models based on ordinary differential equations (ODEs).
In addition to the built-in models (`SIR_MODEL` and `SIRS_MODEL`), you can define
new models using the `new_epi_model()` constructor and simulate them with
`simulate_epi()`.

This vignette covers:

- The SIR and SIRS model equations.
- Typical workflows for simulation and fitting.
- The structure of the main objects (`epi_model`, `sim_epi`, `fit_epi_model`).
- How to incorporate custom epidemic models.

## SIR and SIRS model equations

### SIR

The SIR model follows:

\[\begin{aligned}
\frac{dS}{dt} &= -\beta \frac{S I}{N} \\
\frac{dI}{dt} &= \beta \frac{S I}{N} - \gamma I \\
\frac{dR}{dt} &= \gamma I \\
\frac{dC}{dt} &= \beta \frac{S I}{N}
\end{aligned}\]

Here, `C(t)` represents cumulative infections and is used to derive incidence.
The parameters are `beta` (transmission) and `gamma` (recovery).

### SIRS

The SIRS model adds waning immunity with rate `omega`:

\[\begin{aligned}
\frac{dS}{dt} &= -\beta \frac{S I}{N} + \omega R \\
\frac{dI}{dt} &= \beta \frac{S I}{N} - \gamma I \\
\frac{dR}{dt} &= \gamma I - \omega R \\
\frac{dC}{dt} &= \beta \frac{S I}{N}
\end{aligned}\]

## Built-in models

The package includes two ready-to-use models:

- **SIR_MODEL**: susceptible–infectious–recovered with cumulative infections `C(t)`.
- **SIRS_MODEL**: adds waning immunity (`omega`) and return from `R` to `S`.

Each model is an object of class `epi_model` containing:

- `rhs`: ODE right-hand side (derivatives and auxiliary output).
- `state_names`: state variables.
- `par_names`: parameter names.
- `defaults`, `lower`, `upper`: optional values and bounds.
- `make_init`: initial condition helper.
- `output`: standardized incidence and cumulative columns.

## Simulation with `simulate_epi()`

```{r sir-sim}
library(SIR)

sir_sim <- simulate_epi(
  model = SIR_MODEL,
  n_days = 160,
  parms = c(beta = 0.3, gamma = 0.1),
  init_args = list(N = 1e6, I0 = 20, R0 = 0),
  obs = "none"
)

sir_sim
```

We can plot the trajectories of the main compartments.

```{r sir-plot}
plot(sir_sim)
```

The output of `simulate_epi()` is a `sim_epi` object with components that are
useful for further analysis.

```{r sir-output}
str(sir_sim, max.level = 1)
head(sir_sim$states)
head(sir_sim$incidence_true)
```

## Noisy observed incidence

The simulator can apply an observation model to generate reported incidence:

- `obs = "poisson"`: Poisson counts.
- `obs = "negbin"`: Negative Binomial counts with dispersion `size`.
- `obs = "none"`: no observation (all `NA`).

```{r sir-observed}
set.seed(123)

sir_obs <- simulate_epi(
  model = SIR_MODEL,
  n_days = 120,
  parms = c(beta = 0.25, gamma = 0.1),
  init_args = list(N = 5e5, I0 = 15, R0 = 0),
  rho = 0.4,
  obs = "poisson"
)

plot(sir_obs, what = "incidence")
```

## Fitting with `fit_epi_model()`

`fit_epi_model()` fits an `epi_model` to observed incidence by minimizing the
negative log-likelihood. The fitting input is a vector of equally spaced
incidence counts plus initial conditions.

```{r fit-epi-model, eval=FALSE}
# Simulate observed data
sim_fit <- simulate_epi(
  model = SIR_MODEL,
  n_days = 120,
  parms = c(beta = 0.28, gamma = 0.12),
  init_args = list(N = 3e5, I0 = 12, R0 = 0),
  obs = "poisson",
  rho = 1,
  seed = 7
)

x <- sim_fit$incidence_obs$inc

# Fit parameters
fit <- fit_epi_model(
  x = x,
  model = SIR_MODEL,
  init = list(I = 10, N = 3e5),
  distr = "poisson"
)

fit
fit$par
```

This example uses `eval = FALSE` because optimization can be expensive during
vignette builds.

## Predicting from a fitted model

Once you have a `fit_epi_model` object, you can generate a simulation with the
fitted parameters using `predict()`.

```{r predict-fit, eval=FALSE}
# Predict trajectories using fitted parameters
pred <- predict(fit, n_days = 120)

pred
plot(pred)
```

`predict()` returns a `sim_epi` object, so you can use `plot()` and `summary()`
as with any simulation.

## Object structure

### `epi_model`

Models are stored as `epi_model` objects. You can inspect their components to
see how they are defined:

```{r epi-model-inspect}
SIR_MODEL
names(SIR_MODEL)
SIR_MODEL$state_names
SIR_MODEL$par_names
```

Useful functions related to `epi_model`:

- `simulate_epi()` (deterministic simulation with optional observation).
- `fit_epi_model()` (likelihood-based fitting to incidence data).

### `sim_epi`

The output of `simulate_epi()` is a `sim_epi` object. It includes:

- `model`: model name.
- `params`: parameters used (including `N`).
- `states`: data.frame with state trajectories.
- `incidence_true`: latent incidence.
- `incidence_obs`: observed incidence.
- `cumulative_obs`: observed cumulative counts.

Available methods:

- `print(sim)` prints a compact summary.
- `plot(sim, what = "states" | "incidence")` plots states or incidence.
- `summary(sim)` returns metrics such as `R0`, peak `I`, and total infections.

```{r sim-epi-components}
names(sir_sim)
summary(sir_sim)
```

### `fit_epi_model`

Fitting returns a `fit_epi_model` object, which contains:

- `par`: estimated parameters.
- `model`: fitted `epi_model`.
- `optim`: full `stats::optim()` output.
- `value`, `convergence`, `message`: optimization information.
- `init`, `ini0`: initial conditions.

Available methods:

- `print(fit)` prints a fit summary.
- `predict(fit, ...)` simulates trajectories with fitted parameters.

```{r fit-epi-model-structure, eval=FALSE}
fit
names(fit)
```

## Building a new model

To add a custom model, define:

1. **RHS function** that returns derivatives and incidence (optional).
2. **State and parameter names**.
3. **Initialization function** (optional but recommended).
4. **`epi_model` object** created with `new_epi_model()`.

Below is a SIR model with births and deaths, keeping the population size around
`N`.

```{r custom-model}
# RHS function
sir_dem_rhs <- function(time, state, parms) {
  with(as.list(c(state, parms)), {
    N <- S + I + R
    lambda <- beta * S * I / N
    dS <- mu * N - lambda - mu * S
    dI <- lambda - gamma * I - mu * I
    dR <- gamma * I - mu * R
    dC <- lambda
    list(c(dS, dI, dR, dC), incidence = lambda)
  })
}

# Initial conditions
make_init_sir_dem <- function(N, I0 = 10, R0 = 0) {
  c(S = N - I0 - R0, I = I0, R = R0, C = I0 + R0)
}

SIR_DEM_MODEL <- new_epi_model(
  name = "SIR_DEM",
  rhs = sir_dem_rhs,
  state_names = c("S", "I", "R", "C"),
  par_names = c("beta", "gamma", "mu"),
  defaults = c(beta = 0.3, gamma = 0.1, mu = 1 / (70 * 365)),
  lower = c(beta = 1e-8, gamma = 1e-8, mu = 0),
  upper = c(beta = 2, gamma = 1, mu = 1),
  make_init = make_init_sir_dem,
  output = list(incidence_col = "incidence", cumulative_col = "C")
)

sir_dem_sim <- simulate_epi(
  model = SIR_DEM_MODEL,
  n_days = 200,
  parms = c(beta = 0.28, gamma = 0.12, mu = 1 / (70 * 365)),
  init_args = list(N = 1e6, I0 = 10, R0 = 0),
  obs = "none"
)

plot(sir_dem_sim)
```

If you add more variables or equations, update the RHS and the state/parameter
names in the `epi_model`. The rest of the workflow (simulation, observation,
plotting) remains the same.

## Next steps

Check the documentation for `simulate_epi()`, `fit_epi_model()`, and the
`SIR_MODEL`/`SIRS_MODEL` objects to extend this workflow, add more complex
observations, or fit parameters to data.
