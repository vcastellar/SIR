library(usethis)
getwd()
setwd("~/prg/R/packages/SIR")
usethis::create_package("../SIR")
getwd()
infected <- read.csv("./data/infectedCV.csv")
infected
aggregate(CasosAcum ~ GrupoEdad + Sexo, data = infected, Fun = sum)
aggregate(CasosAcum ~ GrupoEdad + Sexo, data = infected, FUN = sum)
aggregate(CasosAcum ~ fecha, data = infected, FUN = sum)
infected <- aggregate(CasosAcum ~ fecha, data = infected, FUN = sum)
infected$CasosAcum,
infected
casos_ts <- ts(
infected$CasosAcum,
start = c(2020, 148),
frequency = 365
)
casos_ts
plot(casos_ts)
saveRDS(casos_ts, "./data/casos_ts.rds")
infected <- casos_ts
inc_pct <- rollapply(infected, width = 2, FUN = function(x) (x[2] - x[1]) / x[1], align = "left")
suppressPackageStartupMessages({
library(dplyr)
library(lubridate)
library(tidyr)
library(reshape2)
library(xts)
library(zoo)
library(deSolve)
})
inc_pct <- lubridate::rollapply(infected, width = 2, FUN = function(x) (x[2] - x[1]) / x[1], align = "left")
inc_pct <- lubridate::rollapply(infected, width = 2, FUN = function(x) (x[2] - x[1]) / x[1], align = "left")
inc_pct <- rollapply(infected, width = 2, FUN = function(x) (x[2] - x[1]) / x[1], align = "left")
inc_pct
alpha <- rollapply(inc_pct, width = 4, FUN = mean)
doubling_days <- log(2) / log(1 + alpha)
doubling_days
doubling_days[is.infinite(doubling_days)] <- NA
list(inc_pct = inc_pct, doubling_days = doubling_days)
plot(double_days)
plot(doubling_days)
infected <- as.numeric(infected)
infected
n <- length(infected)
if (n < 5) {
stop("Se necesitan al menos 5 observaciones para calcular inc_pct (2) y alpha (4).")
}
# 1) Incremento porcentual diario: (x[t+1] - x[t]) / x[t], para t = 1..n-1
inc_pct <- (infected[2:n] - infected[1:(n - 1)]) / infected[1:(n - 1)]
inc_pct
# 2) Media móvil de 4 sobre inc_pct (equivalente a rollapply(width=4, mean, align='left'))
#    Con embed: filas = ventanas, columnas = valores
alpha <- rowMeans(embed(inc_pct, 4))
alpha
# 3) Días de duplicación
doubling_days <- log(2) / log(1 + alpha)
doubling_days[is.infinite(doubling_days)] <- NA_real_
list(
inc_pct = inc_pct,
doubling_days = doubling_days
)
plot(alpha)
plot(alpha, type = 'l')
source("~/prg/R/packages/SIR/R/compute_growth_metrics.R")
infected <- ts(c(100, 110, 121, 133, 146, 161))
out <- compute_growth_metrics_base(infected)
out$inc_pct
out$doubling_days
infected <- readRDS("./data/casos_ts.rds")
out <- compute_growth_metrics_base(infected)
out$inc_pct
out$doubling_days
library(devtools)
devtools::document()
devtools::document()
devtools::document()
?compute_growth_metrics_base
?compute_growth_metrics_base
library(SIR)
devtools::document()
remove.packages("SIR")
devtools::load_all(".")
,libPaths()
.libPaths()
?install.packages()
remove.packages("SIR")
find.package("SIR", quiet = TRUE)
installed.packages()[installed.packages()[, "Package"] == "SIR", c("Package", "LibPath", "Version")]
q()
xsim <- simulate_sir(beta = 0.3, gamma = 0.15)
x <- round(diff(xsim$states$C ))    # longitud n_days
plot(x)
fit <- fit_sir_model(x)
params <- fit
times <- seq_along(x)
init <- c(S = 1e6 -10,
I = 10,
R = 0,
C = 10)
out <- deSolve::ode(y = init,
times = times,
func = sir_c,
parms = params,
method = "lsoda")
out <- as.data.frame(out)
plot(x)
lines(out$incidence, lty = 2)
plot(cumsum(x))
lines(out$C, type = 'l', lty = 2)
plot(x)
lines(out$incidence, lty = 2, col = "red", lyt = 2
)
lines(out$incidence, lty = 2, col = "red", lty = 2)
xsim <- simulate_sir(beta = 0.3, gamma = 0.15)
x <- round(diff(xsim$states$C ))    # longitud n_days
x
xsim <- simulate_sir(beta = 0.4, gamma = 0.3, n_days = 300)
x <- xsim$incidence_obs$inc
x
plot(x)
x <- xsim$incidence_obs$inc    # longitud n_days
plot(x)
fit <- fit_sir_model(x)
params <- fit
times <- seq_along(x)
init <- c(S = 1e6 -10,
I = 10,
R = 0,
C = 10)
out <- deSolve::ode(y = init,
times = times,
func = sir_c,
parms = params,
method = "lsoda")
out <- as.data.frame(out)
plot(x)
lines(out$incidence, lty = 2, col = "red", lty = 2)
?lines
lines(out$incidence, lty = 2, col = "red")
plot(cumsum(x))
lines(out$C, type = 'l', lty = 2)
out$C,
out$C
lines(out$C, type = 'l', lty = 2, col = "red)
lines(out$C, type = 'l', lty = 2, col = "red")
multi_start_optim <- function(sir, n = 30,
beta_range  = c(0.01, 2),
gamma_range = c(0.02, 1)) {
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
par0 <- c(runif(1, beta_range[1], beta_range[2]),
runif(1, gamma_range[1], gamma_range[2]))
opt <- optim(par0, fn, method = "L-BFGS-B",
lower = c(1e-8, 1e-8),
upper = c(beta_range[2], gamma_range[2]))
if (is.finite(opt$value) && opt$value < best$value) best <- list(value=opt$value, par=opt$par, opt=opt)
}
best
}
multi_start_optim()
multi_start_optim <- function(fn = sir, n = 30,
beta_range  = c(0.01, 2),
gamma_range = c(0.02, 1)) {
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
par0 <- c(runif(1, beta_range[1], beta_range[2]),
runif(1, gamma_range[1], gamma_range[2]))
opt <- optim(par0, fn, method = "L-BFGS-B",
lower = c(1e-8, 1e-8),
upper = c(beta_range[2], gamma_range[2]))
if (is.finite(opt$value) && opt$value < best$value) best <- list(value=opt$value, par=opt$par, opt=opt)
}
best
}
multi_start_optim()
multi_start_optim <- function(fn = "sir", n = 30,
beta_range  = c(0.01, 2),
gamma_range = c(0.02, 1)) {
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
par0 <- c(runif(1, beta_range[1], beta_range[2]),
runif(1, gamma_range[1], gamma_range[2]))
opt <- optim(par0, fn, method = "L-BFGS-B",
lower = c(1e-8, 1e-8),
upper = c(beta_range[2], gamma_range[2]))
if (is.finite(opt$value) && opt$value < best$value) best <- list(value=opt$value, par=opt$par, opt=opt)
}
best
}
multi_start_optim()
multi_start_optim <- function(fn = rss, n = 30,
beta_range  = c(0.01, 2),
gamma_range = c(0.02, 1)) {
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
par0 <- c(runif(1, beta_range[1], beta_range[2]),
runif(1, gamma_range[1], gamma_range[2]))
opt <- optim(par0, fn, method = "L-BFGS-B",
lower = c(1e-8, 1e-8),
upper = c(beta_range[2], gamma_range[2]))
if (is.finite(opt$value) && opt$value < best$value) {
best <- list(value=opt$value, par=opt$par, opt=opt)
}
best
}
multi_start_optim()
}
multi_start_optim <- function(fn = rss, n = 30,
beta_range  = c(0.01, 2),
gamma_range = c(0.02, 1)) {
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
par0 <- c(runif(1, beta_range[1], beta_range[2]),
runif(1, gamma_range[1], gamma_range[2]))
opt <- optim(par0, fn, method = "L-BFGS-B",
lower = c(1e-8, 1e-8),
upper = c(beta_range[2], gamma_range[2]))
if (is.finite(opt$value) && opt$value < best$value) {
best <- list(value=opt$value, par=opt$par, opt=opt)
}
best
}
}
multi_start_optim()
rss <- function(theta) {
names(theta) <- c("beta", "gamma")
out <- deSolve::ode(y = ini0,
times = times,
func = sir_c,
parms = theta,
method = "lsoda")
mu <- diff(as.data.frame(out)[['C']])
eps <- 1e-8
mu <- pmax(mu, eps)
-sum(dpois(x, lambda = mu, log = TRUE))
}
multi_start_optim <- function(fn, n = 30,
beta_range  = c(0.01, 2),
gamma_range = c(0.02, 1)) {
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
par0 <- c(runif(1, beta_range[1], beta_range[2]),
runif(1, gamma_range[1], gamma_range[2]))
opt <- optim(par0, fn, method = "L-BFGS-B",
lower = c(1e-8, 1e-8),
upper = c(beta_range[2], gamma_range[2]))
if (is.finite(opt$value) && opt$value < best$value) {
best <- list(value=opt$value, par=opt$par, opt=opt)
}
best
}
}
multi_start_optim(fn = rss)
times <- seq_along(x)
ini0 <- c(S = init$N - init$I,
I = init$I,
R = 0,
C = init$I)
init = list(I = 10, N = 1e6)
times <- seq_along(x)
ini0 <- c(S = init$N - init$I,
I = init$I,
R = 0,
C = init$I)
multi_start_optim(fn = rss)
multi_start_optim <- function(fn, n = 30,
beta_range  = c(0.01, 2),
gamma_range = c(0.02, 1)) {
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
par0 <- c(runif(1, beta_range[1], beta_range[2]),
runif(1, gamma_range[1], gamma_range[2]))
opt <- optim(par0, fn, method = "L-BFGS-B",
lower = c(1e-8, 1e-8),
upper = c(beta_range[2], gamma_range[2]))
if (is.finite(opt$value) && opt$value < best$value) {
best <- list(value=opt$value, par=opt$par, opt=opt)
}
return(best)
}
}
multi_start_optim <- function(fn, n = 10,
beta_range  = c(0.01, 2),
gamma_range = c(0.02, 1)) {
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
par0 <- c(runif(1, beta_range[1], beta_range[2]),
runif(1, gamma_range[1], gamma_range[2]))
opt <- optim(par0, fn, method = "L-BFGS-B",
lower = c(1e-8, 1e-8),
upper = c(beta_range[2], gamma_range[2]))
if (is.finite(opt$value) && opt$value < best$value) {
best <- list(value=opt$value, par=opt$par, opt=opt)
}
return(best)
}
}
multi_start_optim(fn = rss)
best_init_parms <- multi_start_optim(fn = rss)
opt <- optim(
par = best_init_parms,
fn  = rss,
method = "L-BFGS-B",
lower = c(0, 0),
control = list(maxit = 5000)
)
best_init_parms
opt <- optim(
par = best_init_parms$opt$par,
fn  = rss,
method = "L-BFGS-B",
lower = c(0, 0),
control = list(maxit = 5000)
)
opt
opt$message
opt_par <- setNames(opt$par, c("beta", "gamma"))
opt_par
xsim <- simulate_sir(beta = 0.3, gamma = 0.1)
x <- xsim$incidence_obs$inc    # longitud n_days
plot(x)
fit <- fit_sir_model(x)
params <- fit
params
times <- seq_along(x)
init <- c(S = 1e6 -10,
I = 10,
R = 0,
C = 10)
out <- deSolve::ode(y = init,
times = times,
func = sir_c,
parms = params,
method = "lsoda")
out <- as.data.frame(out)
plot(x)
lines(out$incidence, lty = 2, col = "red")
plot(cumsum(x))
lines(out$C, type = 'l', lty = 2, col = "red")
