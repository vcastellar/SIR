opt$message
opt_par <- setNames(opt$par, c("beta", "gamma"))
opt_par
xsim <- simulate_sir(beta = 0.3, gamma = 0.1)
x <- xsim$incidence_obs$inc    # longitud n_days
plot(x)
fit <- fit_sir_model(x, init = list(I = xsim$states$I[1],
N = xsim$states$S[1] + xsim$states$I[1]))
params <- fit
params
times <- seq_along(x)
init <- c(S = 1e6 -10,
I = 10,
R = 0,
C = 10)
out <- deSolve::ode(y = init,
times = times,
func = sir_c,
parms = params,
method = "lsoda")
out <- as.data.frame(out)
plot(x)
lines(out$incidence, lty = 2, col = "red")
plot(cumsum(x))
xsim <- simulate_sir(beta = 0.3, gamma = 0.1)
x <- xsim$incidence_obs$inc    # longitud n_days
plot(x)
fit <- fit_sir_model(x, init = list(I = xsim$states$I[1],
N = xsim$states$S[1] + xsim$states$I[1]))
xsim <- simulate_sir(beta = 0.3, gamma = 0.1)
x <- xsim$incidence_obs$inc    # longitud n_days
plot(x)
fit <- fit_sir_model(x, init = list(I = xsim$states$I[1],
N = xsim$states$S[1] + xsim$states$I[1]))
xsim <- simulate_sir(beta = 0.3, gamma = 0.1)
x <- xsim$incidence_obs$inc    # longitud n_days
plot(x)
fit <- fit_sir_model(x, init = list(I = xsim$states$I[1],
N = xsim$states$S[1] + xsim$states$I[1]))
fit <- fit_sir_model(x, init = list(I = xsim$states$I[1],
N = xsim$states$S[1] + xsim$states$I[1]))
fit <- fit_sir_model(x, init = list(I = xsim$states$I[1],
N = xsim$states$S[1] + xsim$states$I[1]))
fit
params <- fit
times <- seq_along(x)
init <- c(S = 1e6 -10,
I = 10,
R = 0,
C = 10)
out <- deSolve::ode(y = init,
times = times,
func = sir_c,
parms = params,
method = "lsoda")
out <- as.data.frame(out)
plot(x)
lines(out$incidence, lty = 2, col = "red")
plot(cumsum(x))
source("~/.active-rstudio-document")
simulate_epi <- function(
n_days = 200,
model = c("sir", "sirs"),
N = 1e6,
beta = 0.35,
gamma = 0.10,
omega = 0.0,        # solo se usa en SIRS (tasa pérdida inmunidad, 1/día)
I0 = 10,
R0 = 0,
rho = 1,            # tasa de notificación (0-1)
obs = c("negbin", "poisson"),
size = 20,          # dispersión para NegBin
seed = NULL
) {
model <- match.arg(model)
obs   <- match.arg(obs)
if (!is.null(seed)) set.seed(seed)
# RHS (sistema ODE) según modelo
rhs <- switch(
model,
sir = function(time, state, parms) {
with(as.list(c(state, parms)), {
Ntot <- S + I + R
lambda <- beta * S * I / Ntot
dS <- -lambda
dI <-  lambda - gamma * I
dR <-  gamma * I
dC <-  lambda
list(c(dS, dI, dR, dC), incidence = lambda)
})
},
sirs = function(time, state, parms) {
with(as.list(c(state, parms)), {
Ntot <- S + I + R
lambda <- beta * S * I / Ntot
dS <- -lambda + omega * R
dI <-  lambda - gamma * I
dR <-  gamma * I - omega * R
dC <-  lambda
list(c(dS, dI, dR, dC), incidence = lambda)
})
}
)
# Estado inicial
init <- c(
S = N - I0 - R0,
I = I0,
R = R0,
C = I0 + R0
)
times <- 0:n_days
# Parámetros según modelo
parms <- if (model == "sir") {
c(beta = beta, gamma = gamma)
} else {
c(beta = beta, gamma = gamma, omega = omega)
}
out <- deSolve::ode(
y = init,
times = times,
func = rhs,
parms = parms,
method = "lsoda"
)
out <- as.data.frame(out)
# Incidencia "verdadera"
inc_true <- out$incidence
# Observación: reportados ~ rho * incidencia
mu <- pmax(rho * inc_true, 0)
inc_obs <- switch(
obs,
poisson = stats::rpois(length(mu), lambda = mu),
negbin  = stats::rnbinom(length(mu), mu = mu, size = size)
)
cum_obs <- cumsum(inc_obs)
list(
params = list(
model = model, N = N, beta = beta, gamma = gamma, omega = omega,
I0 = I0, R0 = R0, rho = rho, obs = obs, size = size
),
states = out[, c("time", "S", "I", "R", "C")],
incidence_true = data.frame(time = out$time, inc = inc_true),
incidence_obs  = data.frame(time = out$time, inc = inc_obs),
cumulative_obs = data.frame(time = out$time, cases_cum = cum_obs)
)
}
simulate_epi <- function(
n_days = 200,
model = c("sir", "sirs"),
N = 1e6,
beta = 0.35,
gamma = 0.10,
omega = 0.0,        # solo se usa en SIRS (tasa pérdida inmunidad, 1/día)
I0 = 10,
R0 = 0,
rho = 1,            # tasa de notificación (0-1)
obs = c("negbin", "poisson"),
size = 20,          # dispersión para NegBin
seed = NULL
) {
model <- match.arg(model)
obs   <- match.arg(obs)
if (!is.null(seed)) set.seed(seed)
# RHS (sistema ODE) según modelo
rhs <- switch(
model,
sir = function(time, state, parms) {
with(as.list(c(state, parms)), {
Ntot <- S + I + R
lambda <- beta * S * I / Ntot
dS <- -lambda
dI <-  lambda - gamma * I
dR <-  gamma * I
dC <-  lambda
list(c(dS, dI, dR, dC), incidence = lambda)
})
},
sirs = function(time, state, parms) {
with(as.list(c(state, parms)), {
Ntot <- S + I + R
lambda <- beta * S * I / Ntot
dS <- -lambda + omega * R
dI <-  lambda - gamma * I
dR <-  gamma * I - omega * R
dC <-  lambda
list(c(dS, dI, dR, dC), incidence = lambda)
})
}
)
# Estado inicial
init <- c(
S = N - I0 - R0,
I = I0,
R = R0,
C = I0 + R0
)
times <- 0:n_days
# Parámetros según modelo
parms <- if (model == "sir") {
c(beta = beta, gamma = gamma)
} else {
c(beta = beta, gamma = gamma, omega = omega)
}
out <- deSolve::ode(
y = init,
times = times,
func = rhs,
parms = parms,
method = "lsoda"
)
out <- as.data.frame(out)
# Incidencia "verdadera"
inc_true <- out$incidence
# Observación: reportados ~ rho * incidencia
mu <- pmax(rho * inc_true, 0)
inc_obs <- switch(
obs,
poisson = stats::rpois(length(mu), lambda = mu),
negbin  = stats::rnbinom(length(mu), mu = mu, size = size)
)
cum_obs <- cumsum(inc_obs)
list(
params = list(
model = model, N = N, beta = beta, gamma = gamma, omega = omega,
I0 = I0, R0 = R0, rho = rho, obs = obs, size = size
),
states = out[, c("time", "S", "I", "R", "C")],
incidence_true = data.frame(time = out$time, inc = inc_true),
incidence_obs  = data.frame(time = out$time, inc = inc_obs),
cumulative_obs = data.frame(time = out$time, cases_cum = cum_obs)
)
}
sim1 <- simulate_sir(model = "sir", n_days = 200, N = 1e6, beta = 0.3, gamma = 0.1)
sim1 <- simulate_epi(model = "sir", n_days = 200, N = 1e6, beta = 0.3, gamma = 0.1)
plot(sim1$states$time, sim1$states$I, type = "l")
sim2 <- simulate_epi(model = "sirs", omega = 1/180, n_days = 600, beta = 0.3, gamma = 0.1)
plot(sim2$states$time, sim2$states$I, type = "l")
sim_sir <- simulate_epi(
n_days = 300, model = "sir",
N = 1e6, beta = 0.30, gamma = 0.10,
I0 = 20, rho = 0.25, obs = "negbin", size = 15, seed = 1
)
head(sim_sir$incidence_obs)
# SIRS simulation (average immunity duration ~ 180 days)
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/180,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs$states$time, sim_sirs$states$I, type = "l",
xlab = "Days", ylab = "I(t)")
str(sim_sirs$states)
lines(sim_sirs$states$time$R, col = "red2, lty = 2)
lines(sim_sirs$state$time, sim_sirs$states$time$R, col = "red2, lty = 2)
lines(sim_sirs$state$time, sim_sirs$states$time$R, col = "red2", lty = 2)
lines(sim_sirs$state$time, sim_sirs$states$R, col = "red2", lty = 2)
sim_sirs$states
?sirs
plot(sim_sirs$states$time, sim_sirs$states$R, type = "l",
xlab = "Days", ylab = "I(t)")
lines(sim_sirs$state$time, sim_sirs$states$I, col = "red2", lty = 2)
lines(sim_sirs$state$time, sim_sirs$states$S, col = "red2", lty = 2)
plot(sim_sirs$states$time, sim_sirs$states$C, type = "l",
xlab = "Days", ylab = "I(t)")
lines(sim_sirs$state$time, sim_sirs$states$I, col = "red2", lty = 2)
lines(sim_sirs$state$time, sim_sirs$states$R, col = "red2", lty = 2)
plot(sim_sirs$states$time, sim_sirs$states$S, type = "l",
xlab = "Days", ylab = "I(t)")
lines(sim_sirs$state$time, sim_sirs$states$I, col = "red2", lty = 2)
lines(sim_sirs$state$time, sim_sirs$states$R, col = "red2", lty = 2)
plot(sim_sirs$states$time, sim_sirs$states$S, type = "l",
xlab = "Days", ylab = "S(t)")
lines(sim_sirs$state$time, sim_sirs$states$I, col = "red", lty = 2)
lines(sim_sirs$state$time, sim_sirs$states$R, col = "blue", lty = 2)
xlab = "Days", ylab = "S(t)", ylim = c(0, max(sim_sirs$states$S)))
max(sim_sirs$states$S)
plot(sim_sirs$states$time, sim_sirs$states$S, type = "l",
xlab = "Days", ylab = "S(t)", ylim = c(0, max(sim_sirs$states$S)))
lines(sim_sirs$state$time, sim_sirs$states$I, col = "red", lty = 2)
lines(sim_sirs$state$time, sim_sirs$states$R, col = "blue", lty = 2)
plot(sim_sirs$states$time, sim_sirs$states$S,
type = "l",
col  = "black",
lwd  = 2,
ylim = c(0, max(sim_sirs$states$S)),
xlab = "Time (days)",
ylab = "Number of individuals",
main = "SIRS model simulation")
lines(sim_sirs$states$time, sim_sirs$states$I,
col = "red",
lwd = 2,
lty = 2)
lines(sim_sirs$states$time, sim_sirs$states$R,
col = "blue",
lwd = 2,
lty = 3)
legend("right",
legend = c("Susceptible (S)", "Infectious (I)", "Recovered (R)"),
col    = c("black", "red", "blue"),
lty    = c(1, 2, 3),
lwd    = 2,
bty    = "n")
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/180,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
class(sim_iris)
class(sim_sirs)
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/180,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
class(sim_sirs)
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/180,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
sim_sirs
class(sim_sirs)
devtools::load_all()
rm(list = "simulate_epi")
devtools::load_all()
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/180,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
sim_sirs
plot(sim_sirs)
plot.epi_sim <- function(x, ...) {
with(x$states, {
plot(time, S, type="l", lwd=2,
xlab="Time (days)", ylab="Individuals",
main=paste("Epidemic model:", x$params$model))
lines(time, I, col="red", lwd=2, lty=2)
lines(time, R, col="blue", lwd=2, lty=3)
legend("right",
legend=c("S","I","R"),
col=c("black","red","blue"),
lty=c(1,2,3),
lwd=2, bty="n")
})
}
plot(sim_sirs)
source("~/.active-rstudio-document")
plot(sim_sirs)
# summary epi_sim
summary.epi_sim <- function(object, ...) {
with(object, {
list(
model = params$model,
R0 = params$beta / params$gamma,
peak_I = max(states$I),
total_infections = max(states$C)
)
})
}
summary(sim_sirs)
# SIRS simulation (average immunity duration ~ 90 days)
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/90,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/30,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/15,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
# SIRS simulation (average immunity duration ~ 180 days)
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/300,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
# SIRS simulation (average immunity duration ~ 180 days)
sim_sirs <- simulate_epi(
n_days = 1200, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/300,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
# SIRS simulation (average immunity duration ~ 360 days)
sim_sirs <- simulate_epi(
n_days = 1400, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/360,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
# SIRS simulation (average immunity duration ~ 360 days)
sim_sirs <- simulate_epi(
n_days = 1400, model = "sirs",
N = 1e6, beta = 0.50, gamma = 0.10, omega = 1/360,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
# SIRS simulation (average immunity duration ~ 360 days)
sim_sirs <- simulate_epi(
n_days = 1400, model = "sirs",
N = 1e6, beta = 0.50, gamma = 0.05, omega = 1/360,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
# SIRS simulation (average immunity duration ~ 360 days)
sim_sirs <- simulate_epi(
n_days = 1400, model = "sirs",
N = 1e6, beta = 0.50, gamma = 0.2, omega = 1/360,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
# SIRS simulation (average immunity duration ~ 360 days)
sim_sirs <- simulate_epi(
n_days = 1400, model = "sirs",
N = 1e6, beta = 0.70, gamma = 0.2, omega = 1/360,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
# SIRS simulation (average immunity duration ~ 90 days)
sim_sirs <- simulate_epi(
n_days = 1400, model = "sirs",
N = 1e6, beta = 0.70, gamma = 0.2, omega = 1/90,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
# SIRS simulation (average immunity duration ~ 180 days)
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/180,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
# SIR simulation
sim_sir <- simulate_epi(
n_days = 300, model = "sir",
N = 1e6, beta = 0.30, gamma = 0.10,
I0 = 20, rho = 0.25, obs = "negbin", size = 15, seed = 1
)
plot(sim_sir)
# SIRS simulation (average immunity duration ~ 180 days)
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/180,
I0 = 20, rho = 1, obs = "poisson", seed = 1
)
plot(sim_sirs)
# SIRS simulation (average immunity duration ~ 180 days)
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/80,
I0 = 20, rho = 1, obs = "poisson", seed = 1
)
plot(sim_sirs)
print.sim_epi <- function(x, ...) {
if (!inherits(x, "sim_epi")) {
stop("Object must be of class 'sim_epi'.")
}
p  <- x$params
st <- x$states
cat("Epidemic simulation\n")
cat("-------------------\n")
cat("Model:            ", toupper(p$model), "\n", sep = "")
cat("Time horizon:     ", max(st$time), " days\n", sep = "")
cat("Population (N):   ", format(p$N, scientific = TRUE), "\n", sep = "")
cat("\nParameters\n")
cat("  beta  (transmission): ", signif(p$beta, 4), "\n", sep = "")
cat("  gamma (recovery):     ", signif(p$gamma, 4), "\n", sep = "")
if (!is.null(p$omega) && p$model == "sirs") {
cat("  omega (immunity loss):", signif(p$omega, 4),
" (mean duration = ", signif(1 / p$omega, 4), " days)\n", sep = "")
}
cat("\nOutcomes\n")
peak_I  <- max(st$I, na.rm = TRUE)
time_pk <- st$time[which.max(st$I)]
total_C <- max(st$C, na.rm = TRUE)
cat("  Peak infectious:      ", format(round(peak_I), big.mark = ","), "\n", sep = "")
cat("  Time of peak:         ", time_pk, " days\n", sep = "")
cat("  Total infections (C): ", format(round(total_C), big.mark = ","), "\n", sep = "")
invisible(x)
}
sim_sirs <- simulate_epi(
n_days = 600, model = "sirs",
N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/180,
I0 = 20, rho = 0.25, obs = "poisson", seed = 1
)
plot(sim_sirs)
#' )
#' plot(sim_sir)
#'
#' # SIRS simulation (average immunity duration ~ 180 days)
#' sim_sirs <- simulate_epi(
#'   n_days = 600, model = "sirs",
#'   N = 1e6, beta = 0.30, gamma = 0.10, omega = 1/180,
#'   I0 = 20, rho = 0.25, obs = "poisson", seed = 1
#' )
#' plot(sim_sirs)
summary(sim_sirs)
print(sim_sirs)
summary(sim_sir)
print(sim_sir)
plot(sim_sir)
