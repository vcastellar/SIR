}
best
par0 <- stats::runif(length(model$par_names), min = lower, max = upper)
par0
opt <- optim(
par = par0,
fn  = fn,
method = "L-BFGS-B",
lower = lower,
upper = upper,
control = control
)
opt
fn
fn(par)
str(fn)
fn <- objective_epi(
model = model,
x = x,
ini0 = ini0,
distr = distr,
size = size
)
cat(fn)
prin(fn)
print(fn)
out <- deSolve::ode(
y = ini0,
times = times,
func = model$rhs,
parms = theta,
method = "lsoda"
)
out
theta
out <- as.data.frame(out)
mu <- diff(out[["C"]])
mu <- pmax(mu, eps)
mu
plot(x)
lines(mu)
model
model$rhs
ini0
ini0 <- c(S = init$N - init$I, I = init$I, R = 0, C = init$I)
ini0
nit = list(I = x[1], N = 1e6)
init = list(I = x[1], N = 1e6)
rm(nit)
gc()
ini0 <- c(S = init$N - init$I, I = init$I, R = 0, C = init$I)
ini0
fn <- objective_epi(
model = model,
x = x,
ini0 = ini0,
distr = distr,
size = size
)
lower <- unname(model$lower[model$par_names])
upper <- unname(model$upper[model$par_names])
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
par0 <- stats::runif(length(model$par_names), min = lower, max = upper)
opt <- optim(
par = par0,
fn  = fn,
method = "L-BFGS-B",
lower = lower,
upper = upper,
control = control
)
if (is.finite(opt$value) && opt$value < best$value) {
best <- list(
value = opt$value,
par   = setNames(opt$par, model$par_names),
opt   = opt
)
}
}
best
times <- seq_along(x)
ini0 <- c(S = init$N - init$I, I = init$I, R = 0, C = init$I)
ini0
multi_start_optim <- function(model,
x, ini0,
n = 30,
distr = c("poisson", "negbin"),
control = list(maxit = 500),
seed = NULL)
)
multi_start_optim(model, x, ini0, n = 30,
distr = c("poisson", "negbin"),
control = list(maxit = 500),
seed = 1)
best_init_parms <- multi_start_optim(fn = rss)
distr <- match.arg(distr)
times <- seq_along(x)
ini0 <- c(S = init$N - init$I, I = init$I, R = 0, C = init$I)
model
x
ini0
n
distr
control
multi_start_optim(model, x, ini0, n = 30,
distr = c("poisson", "negbin"),
control = list(maxit = 500),
seed = 1)
objective_epi <- function(model, x, ini0,
distr = c("poisson", "negbin"),
eps = 1e-8) {
distr <- match.arg(distr)
# Para que diff(C) tenga la misma longitud que x:
times <- 0:length(x)
function(theta) {
names(theta) <- model$par_names
out <- deSolve::ode(
y = ini0,
times = times,
func = model$rhs,
parms = theta,
method = "lsoda"
)
out <- as.data.frame(out)
mu <- diff(out[["C"]])
mu <- pmax(mu, eps)
switch(
distr,
negbin  = -sum(stats::dnbinom(x, mu = mu, size = 10, log = TRUE)),
poisson = -sum(stats::dpois(x, lambda = mu, log = TRUE))
)
}
}
multi_start_optim(model, x, ini0, n = 30,
distr = c("poisson", "negbin"),
control = list(maxit = 500),
seed = 1)
# escaneo Multi-start de parÃ¡metros beta y gamma iniciales
multi_start_optim <- function(model,
x, ini0,
n = 30,
distr = c("poisson", "negbin"),
control = list(maxit = 2000),
seed = NULL) {
if (!is.null(seed)) set.seed(seed)
fn <- objective_epi(
model = model,
x = x,
ini0 = ini0,
distr = distr,
size = size
)
lower <- unname(model$lower[model$par_names])
upper <- unname(model$upper[model$par_names])
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
par0 <- stats::runif(length(model$par_names), min = lower, max = upper)
opt <- optim(
par = par0,
fn  = fn,
method = "L-BFGS-B",
lower = lower,
upper = upper,
control = control
)
if (is.finite(opt$value) && opt$value < best$value) {
best <- list(
value = opt$value,
par   = setNames(opt$par, model$par_names),
opt   = opt
)
}
}
best
}
multi_start_optim(model, x, ini0, n = 30,
distr = c("poisson", "negbin"),
control = list(maxit = 500),
seed = 1)
multi_start_optim <- function(model,
x, ini0,
n = 30,
distr = c("poisson", "negbin"),
control = list(maxit = 2000),
seed = NULL) {
if (!is.null(seed)) set.seed(seed)
fn <- objective_epi(
model = model,
x = x,
ini0 = ini0,
distr = distr
)
lower <- unname(model$lower[model$par_names])
upper <- unname(model$upper[model$par_names])
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
par0 <- stats::runif(length(model$par_names), min = lower, max = upper)
opt <- optim(
par = par0,
fn  = fn,
method = "L-BFGS-B",
lower = lower,
upper = upper,
control = control
)
if (is.finite(opt$value) && opt$value < best$value) {
best <- list(
value = opt$value,
par   = setNames(opt$par, model$par_names),
opt   = opt
)
}
}
best
}
best <- multi_start_optim(model, x, ini0, n = 30,
distr = c("poisson", "negbin"),
control = list(maxit = 500),
seed = 1)
fn <- objective_epi(
model = model,
x = x,
ini0 = ini0,
distr = distr
)
best
opt <- optim(
par = best$opt$par,
fn  = fn,
method = "L-BFGS-B",
lower = lower,
upper = upper,
control = control
)
opt
opt$message
opt_par <- setNames(opt$par, model$par_names)
opt_par
fit <- fit_sir_model(x, model = SIR_MODEL, init = list(I = 10, N = 1e6))
fit
sim2 <- simulate_epi(
model = SIRS_MODEL,
n_days = 200,
parms = c(beta = 0.30, gamma = 0.10, omega = 0.02),
init_args = list(N = 1e6, I0 = 20, R0 = 0),
obs = "none"
)
plot(sim2)
sim2 <- simulate_epi(
model = SIRS_MODEL,
n_days = 200,
parms = c(beta = 0.30, gamma = 0.10, omega = 0.02),
init_args = list(N = 1e6, I0 = 20, R0 = 0),
obs = "none"
)
plot(sim2)
sim2
SIRS_MODEL
x <- SIRS_MODEL
p  <- x$params
st <- x$states
st
toupper(p$model)
x <- SIR_MODEL
str(x)
p  <- x$params
p
st <- x$states
SIR_MODEL
print.sim_epi <- function(x, ...) {
if (!inherits(x, "sim_epi")) {
stop("Object must be of class 'sim_epi'.")
}
p  <- x$params
st <- x$states
cat("Epidemic simulation\n")
cat("-------------------\n")
cat("Model:            ", toupper(p$model), "\n", sep = "")
cat("Time horizon:     ", max(st$time), " days\n", sep = "")
cat("Population (N):   ", format(p$N, scientific = TRUE), "\n", sep = "")
cat("\nParameters\n")
cat("  beta  (transmission): ", signif(p$beta, 4), "\n", sep = "")
cat("  gamma (recovery):     ", signif(p$gamma, 4), "\n", sep = "")
if (!is.null(p$omega) && p$model == "sirs") {
cat("  omega (immunity loss):", signif(p$omega, 4),
" (mean duration = ", signif(1 / p$omega, 4), " days)\n", sep = "")
}
cat("\nOutcomes\n")
peak_I  <- max(st$I, na.rm = TRUE)
time_pk <- st$time[which.max(st$I)]
total_C <- max(st$C, na.rm = TRUE)
cat("  Peak infectious:      ", format(round(peak_I), big.mark = ","), "\n", sep = "")
cat("  Time of peak:         ", time_pk, " days\n", sep = "")
cat("  Total infections (C): ", format(round(total_C), big.mark = ","), "\n", sep = "")
invisible(x)
}
SIM_MODEL
SIR_MODEL
SIR_MODEL
sim2 <- simulate_epi(
model = SIRS_MODEL,
n_days = 200,
parms = c(beta = 0.30, gamma = 0.10, omega = 0.02),
init_args = list(N = 1e6, I0 = 20, R0 = 0),
obs = "none"
)
plot(sim2)
sim2
class(sim2)
str(sim2)
x <- sim2
p  <- x$params
p
st <- x$states
st
cat("Epidemic simulation\n")
cat("-------------------\n")
cat("Model:            ", toupper(p$model), "\n", sep = "")
cat("Time horizon:     ", max(st$time), " days\n", sep = "")
cat("Population (N):   ", format(p$N, scientific = TRUE), "\n", sep = "")
cat("\nParameters\n")
cat("  beta  (transmission): ", signif(p$beta, 4), "\n", sep = "")
cat("  gamma (recovery):     ", signif(p$gamma, 4), "\n", sep = "")
p
unlist(p)
cat("\nParameters\n")
print_params <- function(p) {
for (nm in names(p)) {
cat(nm, ": ", p[[nm]], "\n", sep = "")
}
}
p
cat("\nParameters\n")
for (nm in names(p)) {
cat(nm, ": ", p[[nm]], "\n", sep = "")
}
source("~/prg/R/packages/SIR2/R/metodos.R")
sim2
str(sim2)
sim2 <- simulate_epi(
model = SIRS_MODEL,
n_days = 200,
parms = c(beta = 0.30, gamma = 0.10, omega = 0.02),
init_args = list(N = 1e6, I0 = 20, R0 = 0),
obs = "poisson"
)
sim2
plot(sim2)
sim2
sim2 <- simulate_epi(
model = SIRS_MODEL,
n_days = 200,
parms = c(beta = 0.30, gamma = 0.10, omega = 0.02),
init_args = list(N = 1e6, I0 = 20, R0 = 0),
obs = "poisson",
rho = 1,
seed = 22
)
plot(sim2)
sim2
x <- sim2$incidence_obs$inc
plot(x)
fit <- fit_sir_model(x, model = SIR_MODEL, init = list(I = 10, N = 1e6))
fit
fit <- fit_sir_model(x, model = SIRS_MODEL, init = list(I = 10, N = 1e6))
fit
fit_sir_model <- function(x, model = NULL, distr = c("negbin", "poisson"),
init = list(I = 10, N = 1e6), ...) {
distr <- match.arg(distr)
times <- seq_along(x)
ini0 <- c(S = init$N - init$I, I = init$I, R = 0, C = init$I)
best <- multi_start_optim(model, x, ini0, n = 30,
distr = c("poisson", "negbin"),
control = list(maxit = 500),
seed = 1)
fn <- objective_epi(
model = model,
x = x,
ini0 = ini0,
distr = distr
)
opt <- optim(
par = best$opt$par,
fn  = fn,
method = "L-BFGS-B",
lower = lower,
upper = upper,
control = control
)
opt$message
opt_par <- setNames(opt$par, model$par_names)
return(opt_par)
}
fit <- fit_sir_model(x, model = SIRS_MODEL, init = list(I = 10, N = 1e6))
multi_start_optim <- function(model,
x, ini0,
n = 30,
distr = c("poisson", "negbin"),
control = list(maxit = 2000),
seed = NULL) {
if (!is.null(seed)) set.seed(seed)
fn <- objective_epi(
model = model,
x = x,
ini0 = ini0,
distr = distr
)
lower <- unname(model$lower[model$par_names])
upper <- unname(model$upper[model$par_names])
best <- list(value = Inf, par = NULL, opt = NULL)
for (i in seq_len(n)) {
print(paste("paso: ", i))
par0 <- stats::runif(length(model$par_names), min = lower, max = upper)
opt <- optim(
par = par0,
fn  = fn,
method = "L-BFGS-B",
lower = lower,
upper = upper,
control = control
)
if (is.finite(opt$value) && opt$value < best$value) {
best <- list(
value = opt$value,
par   = setNames(opt$par, model$par_names),
opt   = opt
)
}
}
best
}
fit_sir_model <- function(x, model = NULL, distr = c("negbin", "poisson"),
init = list(I = 10, N = 1e6), ...) {
distr <- match.arg(distr)
times <- seq_along(x)
ini0 <- c(S = init$N - init$I, I = init$I, R = 0, C = init$I)
best <- multi_start_optim(model, x, ini0, n = 30,
distr = c("poisson", "negbin"),
control = list(maxit = 500),
seed = 1)
fn <- objective_epi(
model = model,
x = x,
ini0 = ini0,
distr = distr
)
opt <- optim(
par = best$opt$par,
fn  = fn,
method = "L-BFGS-B",
lower = lower,
upper = upper,
control = control
)
opt$message
opt_par <- setNames(opt$par, model$par_names)
return(opt_par)
}
sim2 <- simulate_epi(
model = SIRS_MODEL,
n_days = 200,
parms = c(beta = 0.30, gamma = 0.10, omega = 0.02),
init_args = list(N = 1e6, I0 = 20, R0 = 0),
obs = "poisson",
rho = 1,
seed = 22
)
plot(sim2)
sim2
x <- sim2$incidence_obs$inc
plot(x)
fit <- fit_sir_model(x, model = SIRS_MODEL, init = list(I = 10, N = 1e6))
fit
ini0
out <- deSolve::ode(y = ini0,
times = times,
func = sir,
parms = fit,
method = "lsoda")
out
lines(out$I, col = "red")
lines(as.data.frame(out)$I, col = "red")
lines(diff(as.data.frame(out)$C), col = "red")
lines(as.data.frame(out)$incidence, col = "red")
?fit_epi_model
sim2 <- simulate_epi(
model = SIRS_MODEL,
n_days = 200,
parms = c(beta = 0.30, gamma = 0.10, omega = 0.02),
init_args = list(N = 1e6, I0 = 20, R0 = 0),
obs = "poisson",
rho = 1,
seed = 22
)
plot(sim2)
x <- sim2$incidence_obs$inc
plot(x, type = "l", xlab = "Day", ylab = "Incidence")
fit <- fit_epi_model(x, model = SIRS_MODEL, init = list(I = 10, N = 1e6))
fit
fit$par
## Compare fitted incidence to observed incidence
times <- 0:length(x)
ini0  <- c(S = 1e6 - 10, I = 10, R = 0, C = 10)
out <- deSolve::ode(
y = ini0,
times = times,
func = SIRS_MODEL$rhs,
parms = fit$par,
method = "lsoda"
)
lines(as.data.frame(out)$incidence, col = "red")
