# SIR — A Minimal Framework for Deterministic Epidemic Models in R

**SIR** is an R package for defining, simulating, fitting, and predicting
deterministic compartmental epidemic models based on systems of ordinary
differential equations (ODEs).

The package is model-agnostic and revolves around a single abstraction:
the `epi_model` object. All model-specific information (states, parameters,
equations, bounds, defaults, and output conventions) is stored in this object
and consumed by generic simulation, inference, and visualization tools.

The current implementation includes built-in **SIR**, **SIRS**, and **SEIR**
models, likelihood-based parameter estimation from incidence data, forward
prediction, and plotting and summary methods.

---

## Features

- Unified abstraction for epidemic models via the `epi_model` class
- Deterministic simulation using `deSolve::ode()`
- Built-in SIR, SIRS, and SEIR compartmental models
- Explicit incidence and cumulative-count handling via auxiliary state `C(t)`
- Observation models for incidence (Poisson and Negative Binomial)
- Likelihood-based parameter estimation with multi-start optimization
- Forward prediction from fitted models
- Base R plotting, printing, and summary methods

---

## Installation

This package is currently under development and not available on CRAN.

You can install it from source (for example, from GitHub):

```r
# install.packages("remotes")
remotes::install_github("vcastellar/SIR")
```

## Dependencies

- **deSolve**
- **stats** (base R)

---

## Core Concepts

### The `epi_model` class

An `epi_model` object encapsulates everything required to define a deterministic
compartmental epidemic model:

- Model name
- ODE right-hand side (`rhs`)
- State variable names
- Parameter names
- Parameter bounds and default values (optional)
- Initial-condition constructor (`make_init`, optional)
- Output conventions (e.g. names of incidence and cumulative variables)
- Optional human-readable equations

Models are created with `new_epi_model()` and can then be passed unchanged to
generic tools such as `simulate_epi()`, `fit_epi_model()`, and `predict()`.

This design cleanly separates **model definition** from **simulation**,
**inference**, and **visualization**.

---

## Built-in Models

The package currently provides the following predefined models:

### `SIR_MODEL`

Susceptible–Infectious–Recovered model with an auxiliary cumulative infections
variable `C(t)`.

### `SIRS_MODEL`

Extension of SIR with waning immunity, allowing transitions from `R` back to
`S` at rate `omega`.

### `SEIR_MODEL`

Susceptible–Exposed–Infectious–Recovered model with a latent period. In this
model, incidence corresponds to transitions from `E` to `I`.

All built-in models include a cumulative state `C(t)` so that daily incidence is
consistently defined as `diff(C)` and can be directly linked to count data.

---

## Simulation

### Basic simulation

```r
library(SIR)

sim <- simulate_epi(
  model = SIR_MODEL,
  n_days = 200,
  parms = c(beta = 0.3, gamma = 0.1),
  init_args = list(N = 1e6, I0 = 20, R0 = 0),
  obs = "poisson",
  seed = 1
)

plot(sim)
plot(sim, what = "incidence")
summary(sim)
```

The simulation returns an object of class `sim_epi` containing:

- Deterministic state trajectories
- True incidence derived from the cumulative state
- Observed incidence generated by the observation model (if enabled)

---

## Observation Models

The latent epidemic dynamics can be mapped to reported incidence using a simple
observation model:

- `"poisson"`: Poisson counts with mean `rho * incidence`
- `"negbin"`: Negative Binomial counts with mean `rho * incidence`
- `"none"`: no observation model (purely deterministic output)

The reporting fraction `rho` controls under-reporting.

---

## Model Fitting

Model parameters can be estimated from incidence count data by minimizing a
negative log-likelihood.

```r
fit <- fit_epi_model(
  x = sim$incidence_obs$inc,
  model = SIR_MODEL,
  distr = "poisson",
  init = list(I = 10, N = 1e6),
  n_starts = 40,
  ms_strategy = "lhs",
  seed = 1
)

fit
fit$par
```

## Fitting approach

- Expected incidence is computed as increments of the cumulative state:  
  `diff(C(t))`

- Likelihood:
  - Poisson
  - Negative Binomial

- Optimization:
  - Multi-start initialization (Latin Hypercube, uniform, or jitter sampling)
  - Final optimization via `optim(..., method = "L-BFGS-B")`

- Parameter bounds are enforced throughout optimization

The result is an object of class `fit_epi_model` containing parameter estimates,
convergence information, and the fitted model definition.

---

## Prediction

Forward deterministic predictions can be generated from a fitted model:

```r
pred <- predict(
  fit,
  n_days = 300,
  init = fit$ini0,
  type = "both"
)

head(pred$states)
head(pred$incidence)
```
### Available prediction outputs

- `"states"`: compartment trajectories
- `"incidence"`: expected incidence time series
- `"both"`: states and incidence

---

## Plotting and Summaries

### Simulation objects (`sim_epi`)

- `plot(sim)` — compartment trajectories
- `plot(sim, what = "incidence")` — observed incidence
- `summary(sim)` — epidemiological summary statistics
- `print(sim)` — concise textual overview

### Fitted models (`fit_epi_model`)

- `print(fit)` — parameter estimates and convergence diagnostics
- `predict()` — forward simulation using fitted parameters

---

## File Overview

The package is currently composed of the following main source files:

- `dependencies.R` — package dependencies
- `constructor.R` — `new_epi_model()` and `epi_model` infrastructure
- `models.R` — SIR, SIRS, and SEIR model definitions
- `simulate_epi.R` — deterministic simulation and observation models
- `optimizador.R` — likelihood objective and multi-start optimization
- `predict.R` — forward prediction from fitted models
- `metodos.R` — plotting, printing, and summary methods

---

## Design Philosophy

- Keep the core minimal and transparent
- Separate model definition from simulation and inference
- Favor explicit likelihood-based inference over ad-hoc fitting
- Use base R and a small dependency footprint
- Provide sensible defaults without hiding assumptions

---

## Status

This package is **experimental** and under active development.  
The API may change as functionality evolves.


