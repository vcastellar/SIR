% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/optimizador.R
\name{fit_epi_model}
\alias{fit_epi_model}
\title{Fit an \code{epi_model} to incidence data by likelihood minimization}
\usage{
fit_epi_model(
  x,
  model = SIR_MODEL,
  distr = c("poisson", "negbin"),
  init = list(I = 10, N = 1e+06),
  control = list(maxit = 500),
  n_starts = 30,
  control_ms = list(maxit = 100),
  seed = 1,
  ...
)
}
\arguments{
\item{x}{Numeric vector of observed incidence counts (e.g. daily cases).}

\item{model}{An \code{epi_model} object to be fitted (e.g. \code{SIR_MODEL} or
\code{SIRS_MODEL}). Defaults to \code{SIR_MODEL}.}

\item{distr}{Character string specifying the observation distribution used in
the likelihood. One of \code{"poisson"} or \code{"negbin"}.}

\item{init}{Named list defining the initial conditions through
\code{init$N} (population size) and \code{init$I} (initial number of
infectious individuals).}

\item{control}{List of control parameters passed to \code{optim()} in the final
optimization.}

\item{n_starts}{Integer. Number of random starting points used in the
multi-start initialization.}

\item{control_ms}{List of control parameters passed to \code{optim()} during
the multi-start phase.}

\item{seed}{Optional integer seed for reproducible multi-start initialization.}

\item{...}{Reserved for future extensions.}
}
\value{
An object of class \code{"fit_epi_model"} with components including:
\describe{
\item{par}{Named numeric vector of fitted model parameters.}
\item{model}{The \code{epi_model} object that was fitted.}
\item{optim}{The full object returned by \code{stats::optim()}.}
\item{value}{Final value of the negative log-likelihood.}
\item{convergence}{Convergence code returned by \code{optim()}.}
\item{message}{Optional convergence message from \code{optim()}.}
\item{init}{List of initial condition arguments supplied by the user.}
\item{ini0}{Named numeric vector of initial state values used internally.}
}
}
\description{
Fits a deterministic compartmental epidemic model (an object of class
\code{"epi_model"}, such as \code{SIR_MODEL} or \code{SIRS_MODEL}) to observed
\strong{incidence count data} by minimizing a \strong{negative log-likelihood}.

The function returns a fitted model object of class \code{"fit_epi_model"},
which contains the estimated parameters together with additional information
about the optimization process, the model definition, and the initial
conditions used for fitting.
}
\details{
\subsection{Fitting approach}{

Internally, the function constructs an objective function using an internal
helper (see \code{objective_epi}, not exported) that:
\itemize{
\item solves the model ODE system using \code{deSolve::ode()} and
\code{model$rhs};
\item computes expected incidence as increments of the cumulative state
\eqn{C(t)} via \code{diff(C)};
\item evaluates a Poisson or Negative Binomial log-likelihood for the
observed incidence vector \code{x}.
}

To improve numerical stability and reduce sensitivity to initial values,
the optimization is initialized via an internal \strong{multi-start} strategy
(see \code{multi_start_optim}, not exported), which samples random initial
parameter vectors within the bounds defined by the model and retains the
best solution as the starting point for the final optimization.
}

\subsection{Data and time grid}{

The input vector \code{x} must represent incidence counts on an equally spaced
time grid (typically daily). The internal objective uses a time grid
\code{times = 0:length(x)} so that \code{diff(C)} has the same length as
\code{x}.
}

\subsection{Model requirements}{

The supplied \code{model} must:
\itemize{
\item be an object of class \code{"epi_model"};
\item provide an ODE right-hand side function compatible with
\code{deSolve::ode()};
\item define parameter names via \code{model$par_names};
\item define parameter bounds via \code{model$lower} and \code{model$upper};
\item include a cumulative state variable \code{C(t)} in the ODE output.
}
}
}
\examples{
\dontrun{
## Simulate a SIRS epidemic and fit the model to observed incidence
sim2 <- simulate_epi(
  model = SIRS_MODEL,
  n_days = 200,
  parms = c(beta = 0.30, gamma = 0.10, omega = 0.02),
  init_args = list(N = 1e6, I0 = 20, R0 = 0),
  obs = "poisson",
  rho = 1,
  seed = 22
)
plot(sim2)

x <- sim2$incidence_obs$inc
plot(x, type = "l", xlab = "Day", ylab = "Incidence")

fit <- fit_epi_model(x, model = SIRS_MODEL, init = list(I = 10, N = 1e6))
fit
fit$par

## Compare fitted incidence to observed incidence
times <- 0:length(x)
ini0  <- c(S = 1e6 - 10, I = 10, R = 0, C = 10)

out <- deSolve::ode(
  y = ini0,
  times = times,
  func = SIRS_MODEL$rhs,
  parms = fit$par,
  method = "lsoda"
)

lines(as.data.frame(out)$incidence, col = "red")
}

}
\seealso{
\code{\link{simulate_epi}}, \code{\link{SIR_MODEL}}, \code{\link{SIRS_MODEL}},
\code{\link[stats]{optim}}, \code{\link[deSolve]{ode}}
}
